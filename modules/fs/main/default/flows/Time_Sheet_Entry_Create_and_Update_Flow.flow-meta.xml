<?xml version="1.0" encoding="UTF-8"?>
<Flow xmlns="http://soap.sforce.com/2006/04/metadata">
    <apiVersion>60.0</apiVersion>
    <assignments>
        <name>Add_TSE_Record_to_TSECollection</name>
        <label>Add TSE Record to TSECollection</label>
        <locationX>1546</locationX>
        <locationY>1271</locationY>
        <assignmentItems>
            <assignToReference>TSERecordCollection</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>TimeSheetEntryRecord</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Overlapped_TSE_Loop</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Assign_Overlapped_Timesheet_Entry_Count</name>
        <label>Assign Overlapped Timesheet Entry Count</label>
        <locationX>1326</locationX>
        <locationY>647</locationY>
        <assignmentItems>
            <assignToReference>OverlappedTSECount</assignToReference>
            <operator>AssignCount</operator>
            <value>
                <elementReference>Get_Overlapped_TimeSheetEntry_Of_Today</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Check_Record_Overlapping</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>TimeSheet_Record_Assignment</name>
        <label>TimeSheet Record Assignment</label>
        <locationX>1282</locationX>
        <locationY>1079</locationY>
        <assignmentItems>
            <assignToReference>TimeSheetEntryRecord.Id</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Overlapped_TSE_Loop.Id</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>TimeSheetEntryRecord.StartTime</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>$Record.EndTime</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Add_TSE_Record_to_TSECollection</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>TimeSheet_Record_Assignment_1</name>
        <label>TimeSheet Record Assignment</label>
        <locationX>1810</locationX>
        <locationY>1079</locationY>
        <assignmentItems>
            <assignToReference>TimeSheetEntryRecord.Id</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Overlapped_TSE_Loop.Id</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>TimeSheetEntryRecord.EndTime</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>$Record.StartTime</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Add_TSE_Record_to_TSECollection</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>TimeSheet_Record_Assignment_2</name>
        <label>TimeSheet Record Assignment</label>
        <locationX>1546</locationX>
        <locationY>1079</locationY>
        <assignmentItems>
            <assignToReference>TimeSheetEntryRecord.Id</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Overlapped_TSE_Loop.Id</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>TimeSheetEntryRecord.StartTime</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>$Record.EndTime</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Add_TSE_Record_to_TSECollection</targetReference>
        </connector>
    </assignments>
    <customErrors>
        <name>Multiple_TSE_Error</name>
        <label>Multiple TSE Error</label>
        <locationX>314</locationX>
        <locationY>1055</locationY>
        <customErrorMessages>
            <errorMessage>You cannot adjust the time sheet entry as multiple time sheet entries are getting affected by your adjustment. Please make sure the change only impact predecessor and successor time sheet entry only</errorMessage>
            <isFieldError>false</isFieldError>
        </customErrorMessages>
    </customErrors>
    <customErrors>
        <name>Not_Submitted_Approved_Error</name>
        <label>Not Submitted/Approved Error</label>
        <locationX>380</locationX>
        <locationY>431</locationY>
        <connector>
            <targetReference>Check_Record_Is_New_or_Old</targetReference>
        </connector>
        <customErrorMessages>
            <errorMessage>You cannot modify, Not Submitted or Approved Timesheet</errorMessage>
            <isFieldError>false</isFieldError>
        </customErrorMessages>
    </customErrors>
    <customErrors>
        <name>Submitted_Approved_Error</name>
        <label>Submitted/Approved Error</label>
        <locationX>116</locationX>
        <locationY>431</locationY>
        <connector>
            <targetReference>Check_Record_Is_New_or_Old</targetReference>
        </connector>
        <customErrorMessages>
            <errorMessage>You cannot modify Submitted or Approved Time Sheet {!$Record.TimeSheetEntryNumber}</errorMessage>
            <isFieldError>false</isFieldError>
        </customErrorMessages>
    </customErrors>
    <decisions>
        <name>Check_Record_Is_New_or_Old</name>
        <label>Check Record Is New or Old</label>
        <locationX>1524</locationX>
        <locationY>431</locationY>
        <defaultConnectorLabel>Default</defaultConnectorLabel>
        <rules>
            <name>If_Old_New_with_Start_EndTime_Change</name>
            <conditionLogic>(1 AND (2 OR 3)) OR 4</conditionLogic>
            <conditions>
                <leftValueReference>IsNew</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.StartTime</leftValueReference>
                <operator>IsChanged</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.EndTime</leftValueReference>
                <operator>IsChanged</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>IsNew</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Get_Overlapped_TimeSheetEntry_Of_Today</targetReference>
            </connector>
            <label>If Old/New with Start/EndTime Change</label>
        </rules>
    </decisions>
    <decisions>
        <name>Check_Record_Overlapping</name>
        <label>Check Record  Overlapping</label>
        <locationX>1326</locationX>
        <locationY>755</locationY>
        <defaultConnector>
            <targetReference>Multiple_TSE_Error</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>If_Overlapping_Size_2</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>OverlappedTSECount</leftValueReference>
                <operator>LessThan</operator>
                <rightValue>
                    <numberValue>2.0</numberValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Overlapped_TSE_Loop</targetReference>
            </connector>
            <label>If Overlapping Size &lt; 2</label>
        </rules>
    </decisions>
    <decisions>
        <name>Check_StartTime_Overlapped</name>
        <label>Check StartTime Overlapped</label>
        <locationX>1546</locationX>
        <locationY>971</locationY>
        <defaultConnector>
            <targetReference>TimeSheet_Record_Assignment_1</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>If EndTime Overlapped</defaultConnectorLabel>
        <rules>
            <name>If_Start_Time_Overlapped</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>Overlapped_TSE_Loop.StartTime</leftValueReference>
                <operator>GreaterThan</operator>
                <rightValue>
                    <elementReference>$Record.StartTime</elementReference>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>Overlapped_TSE_Loop.EndTime</leftValueReference>
                <operator>LessThan</operator>
                <rightValue>
                    <elementReference>$Record.StartTime</elementReference>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>TimeSheet_Record_Assignment</targetReference>
            </connector>
            <label>If Start Time Overlapped</label>
        </rules>
        <rules>
            <name>If_EndTime_Overlapped_with_StartTime</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>Overlapped_TSE_Loop.StartTime</leftValueReference>
                <operator>LessThan</operator>
                <rightValue>
                    <elementReference>$Record.EndTime</elementReference>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>Overlapped_TSE_Loop.EndTime</leftValueReference>
                <operator>GreaterThan</operator>
                <rightValue>
                    <elementReference>$Record.EndTime</elementReference>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>TimeSheet_Record_Assignment_2</targetReference>
            </connector>
            <label>If EndTime Overlapped with StartTime</label>
        </rules>
    </decisions>
    <decisions>
        <name>Check_Update_Record_Validation</name>
        <label>Check Update Record Validation</label>
        <locationX>787</locationX>
        <locationY>323</locationY>
        <defaultConnector>
            <targetReference>Check_Record_Is_New_or_Old</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>If_Parent_TS_is_Submitted_Approval</name>
            <conditionLogic>(1 OR 2) AND 3 AND 4</conditionLogic>
            <conditions>
                <leftValueReference>$Record.TimeSheet.Status</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Submitted</stringValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.TimeSheet.Status</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Approved</stringValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Profile.Name</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Field Service Mechanic</stringValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>IsNew</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Submitted_Approved_Error</targetReference>
            </connector>
            <label>If Parent TS is Submitted/Approval</label>
        </rules>
        <rules>
            <name>If_ParentTS_is_Not_Submitted</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>IsNew</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Profile.Name</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Field Service Supervisor</stringValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.TimeSheet.Status</leftValueReference>
                <operator>NotEqualTo</operator>
                <rightValue>
                    <stringValue>Submitted</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Not_Submitted_Approved_Error</targetReference>
            </connector>
            <label>If ParentTS is Not Submitted</label>
        </rules>
    </decisions>
    <description>This FLow will restrict to modify once time sheet entry is submited.</description>
    <environments>Default</environments>
    <formulas>
        <name>IsNew</name>
        <dataType>Boolean</dataType>
        <expression>ISNEW()</expression>
    </formulas>
    <formulas>
        <name>Today</name>
        <dataType>Date</dataType>
        <expression>TODAY()</expression>
    </formulas>
    <interviewLabel>Time Sheet Entry Create and Update Flow {!$Flow.CurrentDateTime}</interviewLabel>
    <label>Time Sheet Entry Create and Update Flow</label>
    <loops>
        <name>Overlapped_TSE_Loop</name>
        <label>Overlapped TSE Loop</label>
        <locationX>1194</locationX>
        <locationY>863</locationY>
        <collectionReference>Get_Overlapped_TimeSheetEntry_Of_Today</collectionReference>
        <iterationOrder>Asc</iterationOrder>
        <nextValueConnector>
            <targetReference>Check_StartTime_Overlapped</targetReference>
        </nextValueConnector>
        <noMoreValuesConnector>
            <targetReference>Update_Overlapped_TSE</targetReference>
        </noMoreValuesConnector>
    </loops>
    <processMetadataValues>
        <name>BuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>CanvasMode</name>
        <value>
            <stringValue>AUTO_LAYOUT_CANVAS</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>OriginBuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processType>AutoLaunchedFlow</processType>
    <recordLookups>
        <name>Get_Overlapped_TimeSheetEntry_Of_Today</name>
        <label>Get Overlapped TimeSheetEntry Of Today</label>
        <locationX>1326</locationX>
        <locationY>539</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Assign_Overlapped_Timesheet_Entry_Count</targetReference>
        </connector>
        <filterLogic>((1 AND 2) OR (3 AND 4) OR (6 AND 7)) AND 5</filterLogic>
        <filters>
            <field>StartTime</field>
            <operator>LessThan</operator>
            <value>
                <elementReference>$Record.StartTime</elementReference>
            </value>
        </filters>
        <filters>
            <field>EndTime</field>
            <operator>GreaterThan</operator>
            <value>
                <elementReference>$Record.StartTime</elementReference>
            </value>
        </filters>
        <filters>
            <field>StartTime</field>
            <operator>GreaterThan</operator>
            <value>
                <elementReference>$Record.EndTime</elementReference>
            </value>
        </filters>
        <filters>
            <field>EndTime</field>
            <operator>LessThan</operator>
            <value>
                <elementReference>$Record.EndTime</elementReference>
            </value>
        </filters>
        <filters>
            <field>Id</field>
            <operator>NotEqualTo</operator>
            <value>
                <elementReference>$Record.Id</elementReference>
            </value>
        </filters>
        <filters>
            <field>StartTime</field>
            <operator>LessThan</operator>
            <value>
                <elementReference>$Record.EndTime</elementReference>
            </value>
        </filters>
        <filters>
            <field>EndTime</field>
            <operator>GreaterThan</operator>
            <value>
                <elementReference>$Record.EndTime</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>false</getFirstRecordOnly>
        <object>TimeSheetEntry</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordUpdates>
        <name>Update_Overlapped_TSE</name>
        <label>Update Overlapped TSE</label>
        <locationX>1194</locationX>
        <locationY>1463</locationY>
        <inputReference>TSERecordCollection</inputReference>
    </recordUpdates>
    <start>
        <locationX>661</locationX>
        <locationY>0</locationY>
        <connector>
            <targetReference>Check_Update_Record_Validation</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>StartTime</field>
            <operator>IsNull</operator>
            <value>
                <booleanValue>false</booleanValue>
            </value>
        </filters>
        <filters>
            <field>EndTime</field>
            <operator>IsNull</operator>
            <value>
                <booleanValue>false</booleanValue>
            </value>
        </filters>
        <object>TimeSheetEntry</object>
        <recordTriggerType>CreateAndUpdate</recordTriggerType>
        <triggerType>RecordAfterSave</triggerType>
    </start>
    <status>Active</status>
    <variables>
        <name>OverlappedTSECount</name>
        <dataType>Number</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <scale>0</scale>
    </variables>
    <variables>
        <name>TimeSheetEntryRecord</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>TimeSheetEntry</objectType>
    </variables>
    <variables>
        <name>TSERecordCollection</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>TimeSheetEntry</objectType>
    </variables>
</Flow>
